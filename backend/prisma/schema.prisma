// Prisma schema for dual-mode deployment (SQLite for desktop, PostgreSQL for Docker)

generator client {
  provider  = "prisma-client-py"
  interface = "asyncio"
}

datasource db {
  provider = "postgresql" // Change to "postgresql" for Docker mode
  url      = env("DATABASE_URL")
}

// User model - supports both license key (desktop) and password (docker) authentication
model User {
  id           String  @id @default(uuid())
  externalId   String  @unique // Clerk User ID
  email        String  @unique
  firstName    String?
  lastName     String?
  imageUrl     String?
  name         String? // Full name (optional)
  passwordHash String? // For Docker mode
  licenseKey   String? @unique // For Desktop mode
  role         Role    @default(USER)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  // AI Credits (Personal trial credits)
  creditBalance Int @default(5)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  projects           Project[]
  findings           Finding[]
  reports            Report[]
  aiUsageLogs        AiUsageLog[]
  projectMemberships ProjectMember[] // Project team memberships

  @@index([email])
  @@index([licenseKey])
  @@index([externalId])
}

enum Role {
  ADMIN
  USER
  VIEWER
}

// Organization model for multi-tenancy (Docker mode)
model Organization {
  id   String @id @default(uuid())
  name String
  slug String @unique
  plan Plan   @default(FREE)

  // Paddle Billing Integration
  paddleCustomerId   String?             @unique // Paddle's customer ID
  subscriptionId     String?             @unique // Active Paddle subscription ID
  subscriptionStatus SubscriptionStatus? // Subscription state from Paddle
  updateUrl          String? // Paddle URL to update payment method
  cancelUrl          String? // Paddle URL to cancel subscription

  // AI Credits (Organization-level)
  creditBalance Int @default(10)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]
  clients     Client[]
  templates   Template[]
  aiUsageLogs AiUsageLog[]

  @@index([slug])
  @@index([paddleCustomerId])
  @@index([subscriptionId])
}

enum Plan {
  FREE
  PRO
  AGENCY
}

enum SubscriptionStatus {
  active
  past_due
  trialing
  paused
  canceled
}

// License validation table (Desktop mode)
model License {
  id              String    @id @default(uuid())
  licenseKey      String    @unique
  machineId       String?
  activatedAt     DateTime?
  lastValidatedAt DateTime?
  expiresAt       DateTime?
  isActive        Boolean   @default(true)

  plan        Plan @default(FREE)
  maxProjects Int  @default(10)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([licenseKey])
  @@index([machineId])
}

// Client model
model Client {
  id           String  @id @default(uuid())
  name         String
  contactName  String?
  contactEmail String?
  contactPhone String?
  address      String?
  
  // Additional client info
  industry     String?
  companySize  String?  // 'Enterprise', 'SMB', 'Startup'
  websiteUrl   String?
  status       String?  @default("Prospect") // 'Active', 'Inactive', 'Prospect'
  riskLevel    String?  @default("Medium")   // 'High', 'Medium', 'Low'
  tags         String?  // JSON array stored as string
  notes        String?

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects Project[]

  @@index([organizationId])
}

// Project model
model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(PLANNING)
  startDate   DateTime?
  endDate     DateTime?

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  leadId String
  lead   User   @relation(fields: [leadId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  findings Finding[]
  reports  Report[]
  members  ProjectMember[] // Team members with roles

  @@index([clientId])
  @@index([leadId])
  @@index([status])
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  REVIEW
  COMPLETED
  ARCHIVED
}

enum ProjectRole {
  LEAD
  TESTER
  VIEWER
}

// Project Member model (Join table for project team membership)
model ProjectMember {
  id        String      @id @default(uuid())
  projectId String
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      ProjectRole @default(TESTER)
  assignedAt DateTime  @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, userId]) // Prevent duplicate memberships
  @@index([projectId])
  @@index([userId])
  @@index([role])
}

// Finding model
model Finding {
  id          String   @id @default(uuid())
  referenceId String?  @unique // Professional ID like "ACM-001"
  title       String
  description String // Rich text content
  severity    Severity
  cvssScore   Float?
  cvssVector  String?
  cveId       String?

  affectedSystems     String?
  affectedAssetsCount Int     @default(0) // Count of affected assets
  remediation         String? // Rich text content
  references          String? // JSON array of URLs

  status FindingStatus @default(OPEN)

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  templateId String?
  template   Template? @relation(fields: [templateId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  evidences Evidence[]

  @@index([projectId])
  @@index([severity])
  @@index([status])
  @@index([cveId])
  @@index([referenceId])
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFO
}

enum FindingStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  ACCEPTED
  FALSE_POSITIVE
}

// Evidence model (screenshots, files)
model Evidence {
  id       String  @id @default(uuid())
  filename String
  filepath String
  filesize Int
  mimetype String
  caption  String?

  findingId String
  finding   Finding @relation(fields: [findingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([findingId])
}

// Report model
model Report {
  id         String       @id @default(uuid())
  title      String
  reportType ReportType   @default(PENTEST)
  status     ReportStatus @default(DRAFT)

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  generatedById String
  generatedBy   User   @relation(fields: [generatedById], references: [id])

  templateId String?
  template   Template? @relation(fields: [templateId], references: [id])

  pdfPath     String?
  htmlContent String? // Cached HTML

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  generatedAt DateTime?

  @@index([projectId])
  @@index([status])
}

enum ReportType {
  PENTEST
  VULNERABILITY_ASSESSMENT
  COMPLIANCE
  EXECUTIVE_SUMMARY
}

enum ReportStatus {
  DRAFT
  GENERATING
  COMPLETED
  FAILED
}

// Template model (for findings and reports)
model Template {
  id          String       @id @default(uuid())
  name        String
  description String?
  type        TemplateType
  content     String // JSON or HTML content

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  isPublic Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  findings Finding[]
  reports  Report[]

  @@index([type])
  @@index([organizationId])
}

enum TemplateType {
  FINDING
  REPORT
}

// Sync metadata for desktop-cloud synchronization
model SyncMetadata {
  id           String   @id @default(uuid())
  entityType   String // "finding", "project", etc.
  entityId     String
  lastSyncedAt DateTime
  syncHash     String // Hash of entity data
  cloudId      String? // ID in cloud database

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([entityType, entityId])
  @@index([entityType])
  @@index([cloudId])
}

// AI Usage Log (Audit trail for AI credit consumption)
model AiUsageLog {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  action   String // e.g., "generate_report", "ai_rewrite", "cve_lookup"
  cost     Int // Credits consumed
  metadata String? // JSON with additional context

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([organizationId])
  @@index([createdAt])
}
